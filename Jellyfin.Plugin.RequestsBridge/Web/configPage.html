<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Requests Bridge</title>
</head>
<body>
    <div id="RequestsBridgeConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="RequestsBridgeConfigForm">

                    <!-- Basic Configuration -->
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Basic Configuration</h2>
                    </div>
                    <div class="fieldDescription" style="margin-bottom: 1.5em;">
                        Configure your Jellyseerr instance connection. This is required for the plugin to work.
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtJellyseerrBase">
                            Jellyseerr URL (Required)
                        </label>
                        <input is="emby-input" type="text" id="txtJellyseerrBase"
                               placeholder="http://192.168.1.100:5055" required />
                        <div class="fieldDescription">
                            Your local Jellyseerr instance URL. This is used when accessing Jellyfin from your local network.
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtJellyseerrApiKey">
                            Jellyseerr API Key (Required)
                        </label>
                        <input is="emby-input" type="password" id="txtJellyseerrApiKey"
                               placeholder="Enter your Jellyseerr API key" required />
                        <div class="fieldDescription">
                            Find your API key in Jellyseerr under <strong>Settings → General → API Key</strong>.
                        </div>
                    </div>

                    <!-- VPN Configuration -->
                    <div class="sectionTitleContainer flex align-items-center" style="margin-top: 2em;">
                        <h2 class="sectionTitle">VPN / Remote Access Configuration (Optional)</h2>
                    </div>
                    <div class="fieldDescription" style="margin-bottom: 1.5em;">
                        Configure URLs for remote access via VPN (e.g., Tailscale). Leave empty if you don't use VPN.
                        These URLs are used by the Android TV app to connect when you're outside your local network.
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtJellyfinBase">
                            Local Jellyfin URL
                        </label>
                        <input is="emby-input" type="text" id="txtJellyfinBase"
                               placeholder="http://192.168.1.100:8096" />
                        <div class="fieldDescription">
                            Your local Jellyfin URL. Example: <code>http://192.168.1.100:8096</code>
                            <br>Available via API: <code>GET /plugins/requests/jellyfinbase</code>
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtTailscaleJellyseerrBase">
                            Tailscale Jellyseerr URL
                        </label>
                        <input is="emby-input" type="text" id="txtTailscaleJellyseerrBase"
                               placeholder="http://100.x.y.z:5055" />
                        <div class="fieldDescription">
                            Your Jellyseerr Tailscale IP address. Example: <code>http://100.64.0.1:5055</code>
                            <br>Available via API: <code>GET /plugins/requests/tailscale/apibase</code>
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="txtTailscaleJellyfinBase">
                            Tailscale Jellyfin URL
                        </label>
                        <input is="emby-input" type="text" id="txtTailscaleJellyfinBase"
                               placeholder="http://100.99.17.85:8096" />
                        <div class="fieldDescription">
                            Your Jellyfin Tailscale IP address. Example: <code>http://100.64.0.2:8096</code>
                            <br>Available via API: <code>GET /plugins/requests/tailscale/jellyfinbase</code>
                        </div>
                    </div>

                    <!-- Performance Settings -->
                    <div class="sectionTitleContainer flex align-items-center" style="margin-top: 2em;">
                        <h2 class="sectionTitle">Performance Settings</h2>
                    </div>
                    <div class="fieldDescription" style="margin-bottom: 1.5em;">
                        Optimize plugin performance for your setup.
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="chkDisableUserDataOnCollections" />
                            <span>Disable User Data on Collections</span>
                        </label>
                        <div class="fieldDescription checkboxFieldDescription">
                            Enable this if Collections are loading slowly. This disables watch status and progress indicators
                            for Collections, which significantly improves loading performance.
                            <br>Based on <a href="https://github.com/pelluch/jellyfin-plugin-disable-user-data" target="_blank">jellyfin-plugin-disable-user-data</a>.
                        </div>
                    </div>

                    <div style="margin-top: 2em;">
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save Settings</span>
                        </button>
                    </div>
                </form>

                <!-- API Documentation -->
                <div class="sectionTitleContainer flex align-items-center" style="margin-top: 3em;">
                    <h2 class="sectionTitle">API Endpoints (For Developers)</h2>
                </div>
                <div class="fieldDescription" style="margin-bottom: 1em;">
                    These endpoints are used by the Android TV app and other integrations to retrieve configuration.
                </div>
                <div class="fieldDescription">
                    <div style="margin-bottom: 1em;">
                        <strong>Local Network Endpoints:</strong>
                        <ul style="margin: 0.5em 0 0 1.5em;">
                            <li><code>GET /plugins/requests/apibase</code> - Returns Jellyseerr URL</li>
                            <li><code>GET /plugins/requests/jellyfinbase</code> - Returns local Jellyfin URL</li>
                            <li><code>GET /plugins/requests/apikey</code> - Returns Jellyseerr API Key</li>
                        </ul>
                    </div>
                    <div style="margin-bottom: 1em;">
                        <strong>Tailscale / VPN Endpoints:</strong>
                        <ul style="margin: 0.5em 0 0 1.5em;">
                            <li><code>GET /plugins/requests/tailscale/apibase</code> - Returns Tailscale Jellyseerr URL</li>
                            <li><code>GET /plugins/requests/tailscale/jellyfinbase</code> - Returns Tailscale Jellyfin URL</li>
                        </ul>
                    </div>
                    <p style="margin-top: 1em; font-style: italic;">
                        All endpoints return JSON with <code>success</code> boolean and the requested data.
                    </p>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            const RequestsBridgeConfig = {
                pluginUniqueId: '1b7a3e7c-7c7c-43e0-9af0-7c7e8a2f2c01'
            };

            document.querySelector('#RequestsBridgeConfigPage')
                .addEventListener('pageshow', function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(RequestsBridgeConfig.pluginUniqueId)
                        .then(function (config) {
                            document.querySelector('#txtJellyseerrBase').value = config.JellyseerrBase || '';
                            document.querySelector('#txtJellyfinBase').value = config.JellyfinBase || '';
                            document.querySelector('#txtTailscaleJellyseerrBase').value = config.TailscaleJellyseerrBase || '';
                            document.querySelector('#txtTailscaleJellyfinBase').value = config.TailscaleJellyfinBase || '';
                            document.querySelector('#txtJellyseerrApiKey').value = config.JellyseerrApiKey || '';
                            document.querySelector('#chkDisableUserDataOnCollections').checked = config.DisableUserDataOnCollections || false;
                            Dashboard.hideLoadingMsg();
                        });
                });

            document.querySelector('#RequestsBridgeConfigForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(RequestsBridgeConfig.pluginUniqueId)
                        .then(function (config) {
                            config.JellyseerrBase = document.querySelector('#txtJellyseerrBase').value;
                            config.JellyfinBase = document.querySelector('#txtJellyfinBase').value;
                            config.TailscaleJellyseerrBase = document.querySelector('#txtTailscaleJellyseerrBase').value;
                            config.TailscaleJellyfinBase = document.querySelector('#txtTailscaleJellyfinBase').value;
                            config.JellyseerrApiKey = document.querySelector('#txtJellyseerrApiKey').value;
                            config.DisableUserDataOnCollections = document.querySelector('#chkDisableUserDataOnCollections').checked;
                            ApiClient.updatePluginConfiguration(RequestsBridgeConfig.pluginUniqueId, config)
                                .then(function () {
                                    Dashboard.processPluginConfigurationUpdateResult();
                                });
                        });
                    return false;
                });
        </script>
    </div>
</body>
</html>
